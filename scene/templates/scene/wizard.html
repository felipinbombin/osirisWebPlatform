{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block extrahead %}
  {{ block.super }}
  <script type="text/javascript" src="{% url 'admin:jsi18n' %}"></script>
  {{ media }}
{% endblock %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" type="text/css" href="{% static "admin/css/forms.css" %}" />
  {% with "components/gentelella/vendors/" as gentelella_static %}
    <link href="{% static gentelella_static|add:"dropzone/dist/min/dropzone.min.css" %}" rel="stylesheet" />
    <link href="{% static gentelella_static|add:"pnotify/dist/pnotify.css" %}" rel="stylesheet">
    <link href="{% static gentelella_static|add:"pnotify/dist/pnotify.buttons.css" %}" rel="stylesheet">
    <link href="{% static gentelella_static|add:"pnotify/dist/pnotify.nonblock.css" %}" rel="stylesheet">
  {% endwith %}
  <link href="{% static "components/smartwizard/dist/css/smart_wizard.css" %}" rel="stylesheet" />
  <link href="{% static "components/smartwizard/dist/css/smart_wizard_theme_dots.css" %}" rel="stylesheet" />
  <style>
    .sw-theme-dots .step-content {
      background-color: inherit;
    }
    .sw-theme-dots > ul.step-anchor > li.active > a {
      color: #34495E;
    }
    .sw-theme-dots > ul.step-anchor > li.done > a {
      color: #169F85;
    }
    .sw-theme-dots > ul.step-anchor > li.done > a:after {
      background: #169F85;
    }
    .sw-theme-dots > ul.step-anchor > li.active > a:after {
      background: #34495E;
    }

    .dropzone {
      min-height: 196px;
    }
    .btn-excel {
      min-height: 196px;
    }
</style>
{% endblock %}

{% block coltype %}colM{% endblock %}

{% block bodyclass %}
  {{ block.super }} app-{{ opts.app_label }} model-{{ opts.model_name }} change-form
{% endblock %}

{% block content %}
<div id="content-main" class="col-md-12 col-sm-12 col-xs-12">
  <div id="wizard">
    {% include 'scene/stepsHeader.html' %}
    <div>
    <div id="step-1" style="display: none">
      {% include 'scene/step0.html' %}
    </div>
    <div id="step-2" style="display: none">
      {% include 'scene/step1.html' %}
    </div>
    <div id="step-3" style="display: none">
      {% include 'scene/step2.html' %}
    </div>
    <div id="step-4" style="display: none">
      {% include 'scene/step3.html' %}
    </div>
    <div id="step-5" style="display: none">
      {% include 'scene/step4.html' %}
    </div>
    <div id="step-6" style="display: none">
      {% include 'scene/step5.html' %}
    </div>
    <div id="step-7" style="display: none">
      {% include 'scene/step6.html' %}
    </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extrajs %}
  {% with "components/gentelella/vendors/" as gentelella_static %}
    <script src="{% static gentelella_static|add:"dropzone/dist/min/dropzone.min.js" %}"></script>
    <script src="{% static gentelella_static|add:"pnotify/dist/pnotify.js" %}"></script>
    <script src="{% static gentelella_static|add:"pnotify/dist/pnotify.buttons.js" %}"></script>
    <script src="{% static gentelella_static|add:"pnotify/dist/pnotify.nonblock.js" %}"></script>
  {% endwith %}
  <script src="{% static "components/smartwizard/dist/js/jquery.smartWizard.min.js" %}"></script>
  <script src="{% static "components/knockout/dist/knockout.debug.js" %}"></script>
  <script src="{% static "components/js-cookie/src/js.cookie.js" %}"></script>
  <script src="{% static "js/user.notification.js" %}"></script>
  <script src="{% static "js/dropzone.conf.js" %}"></script>
  <script src="{% static "js/wizard.step0.js" %}"></script>
  <script src="{% static "js/wizard.step2.js" %}"></script>
  <script>
  $(document).ready(function(){
      console.log({{ scene.currentStep }});

/**************************************************
* WIZARD LOGIC
***************************************************/

// viewModels to manage each step
let step0ViewModel = new Step0ViewModel();
let step2ViewModel = new Step2ViewModel();

// Initialize the leaveStep event
$("#wizard").on("leaveStep", function(e, anchorObject, stepNumber, stepDirection) {
    return true;
});

// Initialize the showStep event
$("#wizard").on("showStep", function(e, anchorObject, stepNumber, stepDirection, stepPosition) {

    init_sidebar();
    console.log("You are on step " + stepNumber + " now " + stepPosition);

    const URLS = [
        '{% url "scene:getStep0Data" sceneId=scene.id %}',
        '{% url "scene:getStep2Data" sceneId=scene.id %}',
        '{% url "scene:getStep4Data" sceneId=scene.id %}'
    ];

    switch (stepNumber) {
        case 0:
            let step0DOM = document.getElementById('step-1');
            let existsStep1Model = ko.dataFor(step0DOM);
            if (existsStep1Model === undefined) {
                ko.applyBindings(step0ViewModel, step0DOM);
            }
            //retrieve data from server
            $.get(URLS[0], function (data) {
                step0ViewModel.update(data);
                console.log('data of step 0 retrieved succesfully');
            });
            break;
        case 2:
            let step2DOM = document.getElementById('step-3');
            let existsStep2Model = ko.dataFor(step2DOM);
            if (existsStep2Model === undefined) {
                ko.applyBindings(step2ViewModel, step2DOM);
            }
            //retrieve data from server
            $.get(URLS[1], function (data) {
                //step2ViewModel.update(data);
                console.log('data of step 2 retrieved succesfully');
            });
            break;
    }
});

    let nextLogic = function(){
      let currentStep = parseInt(window.location.hash.split('-')[1]) - 1;

      let getUrl = function(stepId){
          let sceneId = {{ scene.id }};
          let url = '/admin/scene/wizard/validate/';

          return url + stepId + '/' + sceneId;
      };
      switch(currentStep){
        case 0:
          if(step0ViewModel.isValid()){
            let data = step0ViewModel.serialize();
            $.post(getUrl(currentStep), data, function(answer){
              // success
              if(answer.status.code === 200){
                $('#wizard').smartWizard('next');
              }
              showNotificationMessage(answer.status);
            });
          }
          break;
        case 2:
          if(step2ViewModel.isValid()){
            let data = step2ViewModel.serialize();
            $.post(getUrl(currentStep), data, function(answer){
              // success
              if(answer.status.code === 200){
                $('#wizard').smartWizard('next');
              }
              showNotificationMessage(answer.status);
            });
          }
          break;
        case 4:
          // ask to server if file was uploaded
          $('#wizard').smartWizard('next');
          break;
        case 1:
        case 3:
        case 5:
        case 6:
          // ask to server if file was uploaded
          $.post(getUrl(currentStep), function(answer){
            // success
            if(answer.status.code === 200){
              $('#wizard').smartWizard('next');
            }else{
              showNotificationMessage(answer.status);
            }
          });
          break;
      }
    };
    let finalButton = $('<button></button>').text('Finalizar')
                      .addClass('btn btn-dark')
                      .on('click', function(){ 
                        alert('Finish button click');
                        console.log(this);
                      });
    let prevButton = $('<button></button>').text('Anterior')
                      .addClass('btn btn-default')
                      .on('click', function(){ 
                        $('#wizard').smartWizard('prev');
                      });
    let nextButton = $('<button></button>').text('Siguiente')
                      .addClass('btn btn-default')
                      .css('padding-right', '5px')
                      .on('click', nextLogic);
    // set wizard
    $('#wizard').smartWizard({
      selected: {{ scene.currentStep }},
      autoAdjustHeight: false,
      markAllPreviousStepsAsDone: true,
      theme: 'dots',
      toolbarSettings: {
        showNextButton: false,
        showPreviousButton: false,
        toolbarPosition: 'top',
        toolbarExtraButtons: [
          prevButton,
          nextButton,
          finalButton
        ],
      },
    });  
  });
  </script>
{% endblock %}
